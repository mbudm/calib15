<html>
	<head>
		 <title>Calib 2015 b</title> 
		 <script type="text/javascript" src="lib/calibration/ui.js"></script>
		 <script type="text/javascript" src="lib/calibration/proxy.js"></script>
	     <script type="text/javascript" src="lib/jquery-1.11.1.js"></script>
		 <link href="style/calibdot.css" media="all" rel="stylesheet" />
	</head>
	<body>
	<div class="calibDot">
		<div class="calibDot--inner">
			<div class="calibDot--bg"></div>
			<div class="calibDot--userHead"></div>
			<div class="calibDot--message"><div class="calibDot--message--inner"><span class="text"></span></div></div>
		</div>
	</div>
	<div class="gazeDot"></div>
	<div class="screenMessage"></div>
	<textarea class="calibDebugger"></textarea>
	
	<script type="text/javascript">
	
	
	/*
	
	Todo list
	
	-- playback recorded head tracking, at original speed (DONE)
	-- add instructions player (DONE)
	-- test thresholds with test data (DONE)
	-- auto adjust thresholds
	-- send calibration data
	-- do calibration check
	-- styles for mid points, perhaps NNE/NNW etc?
	-- enable disable (or flag) based on crosshair (x,y), canthi checking, yaw validation
	-- environment checking. dark/light imbalanced
	
	*/
	
	var xlabs;
	$(function() {
		xlabs = {
			calib:{
				ui:calibUi,
				proxy:calibProxy
			}
		};
		xlabs.calib.ui.setup();
		//xlabs.calib.proxy.debugMode(true);
		$( "body" ).keyup(function( event ) {
			switch( event.which) {
				case 88: //x
					xlabs.calib.proxy.off();
					
					//console.log(JSON.stringify(xlabs.calib.ui.log))
					break;
				case 83: //s
					xlabs.calib.proxy.on();
					xlabs.calib.ui.instructionsStart();
					break;
				case 65: //a
					xlabs.calib.proxy.simMode(true);
					xlabs.calib.ui.simulateStart(slim_calib);
					xlabs.calib.ui.instructionsStart();
					break;
				case 90: //z
					xlabs.calib.ui.simulateStop();
					xlabs.calib.proxy.simMode(false);
					break;
			}
		});
		document.addEventListener( "xLabsApiReady", function() {
			//xlabs.calib.ui.onApiReady();
		});

		document.addEventListener( "xLabsApiState", function( event ) {
			xlabs.calib.ui.onApiState( event.detail );
		});
	});


	
	/*
	type ??
	- task
	- criteria
	- dotmessage
	- screenmessage
	
	*/
	var calibInstructions = [
		{delay:1, task:{ method:'setCalibPosition', param:'topleft' }},
		{delay:2000, msg:"Hi there! Let's calibrate!"},
		{delay:4000, msg:"Practice a bit. Move the yellow dot by gently turning and tilting your head"},
		{delay:2000, msg:"Cool huh? Ok let's move on to the good stuff."},
		{delay:500, expire:15000, msg:"Tilt your head up", criteria:{type:"direction", direction:"up", ma:4, success:"Awesome", delay:500, failsequence:"directionFail"}  },
		{delay:500, expire:15000, msg:"Turn your head to the right", criteria:{type:"direction", direction:"right", ma:4, success:"Excellent", delay:500, failsequence:"directionFail"} },
		{delay:500, expire:15000, msg:"Tilt your head down", criteria:{type:"direction", direction:"down", ma:4, success:"Well done", delay:500, failsequence:"directionFail"}  },
		{delay:500, expire:15000, msg:"Turn your head to the left", criteria:{type:"direction", direction:"left", ma:4, success:"Good", delay:500, failsequence:"directionFail"}  },
		{delay:4000, expire:15000, msg:"Cool bananas, now look here and the green dot will follow.", criteria:{type:"calibrate", threshold:200, ma:2, delay:500, success:"Great, that's close enough.", failsequence:"calibrateFail"}},
		{delay:1,task:{ method:'setCalibVisible', param:false}},
		{delay:1,task:{ method:'setScreenMessage', param:"You've calibrated the top left, next we'll calibrate top right"}},
		{delay:2000, task:{ method:'setScreenMessage', param:"You're doing great, don't forget to relax." }},
		{delay:2000,task:{ method:'setCalibPosition', param:'topright'}},
		{delay:2000, msg:"Let's calibrate this spot."},
		{delay:500, expire:15000, msg:"Tilt up again", criteria:{type:"direction", direction:"up", ma:4, success:"Sweet", delay:500, failsequence:"directionFail"}  },
		{delay:500, expire:15000, msg:"Once more to the right", criteria:{type:"direction", direction:"right", ma:4, success:"Okay", delay:500, failsequence:"directionFail"} },
		{delay:500, expire:15000, msg:"Tilt down", criteria:{type:"direction", direction:"down", ma:4, success:"Great", delay:500, failsequence:"directionFail"}  },
		{delay:500, expire:15000, msg:"Turn left", criteria:{type:"direction", direction:"left", ma:3, success:"Bang on.", delay:500, failsequence:"directionFail"}  },
		{delay:4000, expire:15000, msg:"Okidoke, move the green dot to here with your gaze", criteria:{type:"calibrate", threshold:150, ma:2, delay:500, success:"Excellent!", failsequence:"calibrateFail"}},
		{delay:1,task:{ method:'setCalibVisible', param:false}},
		{delay:1,task:{ method:'setScreenMessage', param:"Woohoo! 2 down, 3 to go."}},
		{delay:2000,task:{ method:'setCalibPosition', param:'bottomright'}},
		{delay:2000, msg:"Get ready to roll."},
		{delay:500, expire:15000, msg:"Tilt up again", criteria:{type:"direction", direction:"up", ma:4, success:"Sweet", delay:500, failsequence:"directionFail"}  },
		{delay:500, expire:15000, msg:"Once more to the right", criteria:{type:"direction", direction:"right", ma:4, success:"Okay", delay:500, failsequence:"directionFail"} },
		{delay:500, expire:15000, msg:"Tilt down", criteria:{type:"direction", direction:"down", ma:4, success:"Great", delay:500, failsequence:"directionFail"}  },
		{delay:500, expire:15000, msg:"Turn left", criteria:{type:"direction", direction:"left", ma:3, success:"Bang on.", delay:500, failsequence:"directionFail"}  },
		{delay:4000, expire:15000, msg:"Now, move the green dot to here with your gaze", criteria:{type:"calibrate", threshold:150, ma:2, delay:500, success:"Super!", failsequence:"calibrateFail"}},
		{delay:1,task:{ method:'setCalibVisible', param:false}},
		{delay:1,task:{ method:'setScreenMessage', param:"Top stuff, 2 more spots to go."}},
		{delay:2000,task:{ method:'setCalibPosition', param:'bottomleft'}},
		{delay:2000, msg:"Over here"},
		{delay:500, expire:15000, msg:"Tilt up ", criteria:{type:"direction", direction:"up", ma:4, success:"Sweet", delay:500, failsequence:"directionFail"}  },
		{delay:500, expire:15000, msg:"To the right", criteria:{type:"direction", direction:"right", ma:4, success:"Okay", delay:500, failsequence:"directionFail"} },
		{delay:500, expire:15000, msg:"Tilt down", criteria:{type:"direction", direction:"down", ma:4, success:"Great", delay:500, failsequence:"directionFail"}  },
		{delay:500, expire:15000, msg:"Turn left", criteria:{type:"direction", direction:"left", ma:3, success:"Bang on.", delay:500, failsequence:"directionFail"}  },
		{delay:4000, expire:15000, msg:"Lastly, move the green dot to here", criteria:{type:"calibrate", threshold:150, ma:2, delay:500, success:"Wunderbar!", failsequence:"calibrateFail"}},
		{delay:1,task:{ method:'setCalibVisible', param:false}},
		{delay:1,task:{ method:'setScreenMessage', param:"One last dot, in the center this time."}},
		{delay:2000,task:{ method:'setCalibPosition', param:'center'}},
		{delay:2000, msg:"This will be easy."},
		{delay:500, expire:15000, msg:"Tilt up ", criteria:{type:"direction", direction:"up", ma:4, success:"Sweet", delay:500, failsequence:"directionFail"}  },
		{delay:500, expire:15000, msg:"To the right", criteria:{type:"direction", direction:"right", ma:4, success:"Okay", delay:500, failsequence:"directionFail"} },
		{delay:500, expire:15000, msg:"Tilt down", criteria:{type:"direction", direction:"down", ma:4, success:"Great", delay:500, failsequence:"directionFail"}  },
		{delay:500, expire:15000, msg:"Turn left", criteria:{type:"direction", direction:"left", ma:3, success:"Bang on.", delay:500, failsequence:"directionFail"}  },
		{delay:4000, expire:15000, msg:"Send the green dot this way", criteria:{type:"calibrate", threshold:150, ma:2, delay:500, success:"Boo-ya!", failsequence:"calibrateFail"}},
		{delay:1,task:{ method:'setGazeDotVisible', param:true}},
		{delay:1,task:{ method:'setScreenMessage', param:"All done, you should be able to move the green dot any where with your gaze now."}},
	];


	var setupSample = {
	    "y": -0.163049757,
	    "p": 0.800989449,
	    "t": 1421387137699,
	    "state": {
	        "persistentActive": false,
	        "persistentUpdateFps": 10,
	        "persistentUpdateCount": 224873,
	        "persistentLastResponse": true,
	        "kvTimestamp": ["1421387087955"],
	        "kvUser": ["eyesdecide"],
	        "kvEmail": "OK",
	        "kvVersion": ["1.7.6"],
	        "kvToolbarEnabled": 0,
	        "kvOverlayEnabled": 0,
	        "kvOverlayMode": 1,
	        "kvOverlaySpotlightMode": 0,
	        "kvOverlayCaptureKeyboard": 0,
	        "kvOverlayCaptureMouse": 0,
	        "kvTrackMouse": 0,
	        "kvClicksEnabled": 0,
	        "kvClickMinDuration": 500,
	        "kvClickMaxDuration": 20000,
	        "kvTrackingScreenX": 135,
	        "kvTrackingScreenY": 183,
	        "kvTrackingEnabled": 1,
	        "kvPinpointEnabled": 0,
	        "kvRealtimeActive": 0,
	        "kvRealtimeEnabled": 1,
	        "kvCameraRecording": 0,
	        "kvCalibrationCentreDistanceThreshold": 0.5,
	        "kvCalibrationConfidenceThreshold": 5,
	        "kvCalibrationPolicy": [""],
	        "kvCalibrationPolicyTimeout": 800,
	        "kvCalibrationRequested": 0,
	        "kvCalibrationActive": 0,
	        "kvCalibrationStatus": null,
	        "kvCalibrationClicks": 0,
	        "kvCalibrationClicksUncalibrated": 0,
	        "kvCalibrationStep": 3,
	        "kvCalibrationMode": 0,
	        "kvCalibrationsCompleted": 0,
	        "kvCalibrationsRequired": 1,
	        "kvValidationEnabled": 1,
	        "kvValidationStatus": 0,
	        "kvValidationErrors": ["F"],
	        "kvValidationRegions": ["Eye[L],Eye[R],Face"],
	        "kvValidationExcessYaw": 1,
	        "kvValidationNoFrames": 0,
	        "kvValidationFaceRect": ["337,278,110,97"],
	        "kvClickLoggingEnabled": 0,
	        "kvWatchLoggingEnabled": 0,
	        "kvGazeLoggingEnabled": 0,
	        "kvGazeAccuracyByPrediction": -1,
	        "kvGazeAccuracyByRobustness": -1,
	        "kvGazeAccuracyByRobustnessEnabled": 1,
	        "kvHeadX": 0.912532866,
	        "kvHeadY": 0.507844388,
	        "kvHeadZ": 1.8282398,
	        "kvHeadRoll": 0.0190452971,
	        "kvHeadPitch": 0.800989449,
	        "kvHeadYaw": -0.163049757,
	        "kvImageSize": ["640,480"],
	        "kvGazeVectorX": 0,
	        "kvGazeVectorY": 0,
	        "persistentResponseTime": 1421387137594
	    }
	}

	</script>
	<script type="text/javascript" src="data/slim_calib.js"></script>
	</body>
</html>
